name: Auto-update Packages

on:
  schedule:
    # Run every 6 hours (at 00:00, 06:00, 12:00, and 18:00 UTC)
    - cron: '0 */6 * * *'

  workflow_dispatch:
    inputs:
      trigger_builds:
        description: 'Trigger COPR builds after update'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  push:
    branches:
      - master
    paths:
      - '.github/workflows/auto-update.yml'
      - 'scripts/update-packages.sh'
      - 'scripts/fetch-version.sh'

jobs:
  update-packages:
    name: Check for package updates
    runs-on: ubuntu-latest

    permissions:
      contents: write

    outputs:
      has_changes: ${{ steps.update.outputs.has_changes }}
      copr_behind: ${{ steps.copr_check.outputs.copr_behind }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git

      - name: Run update script
        id: update
        run: |
          chmod +x scripts/*.sh
          ./scripts/update-packages.sh | tee update-log.txt

          # Check if there are any changes
          CHANGES=$(git diff --name-only | wc -l)
          if [ "$CHANGES" -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No updates found"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Updates detected! ($CHANGES files changed)"
          fi

      - name: Check COPR versions
        id: copr_check
        run: |
          echo "ðŸ” Checking COPR versions against current specs..."
          
          # Check quickshell-git version in COPR
          COPR_QUICKSHELL_GIT=$(curl -s "https://copr.fedorainfracloud.org/api_3/package/list?ownername=avengemedia&projectname=danklinux&packagename=quickshell-git" | jq -r '.items[0].latest_build.version // "not_found"')
          CURRENT_QUICKSHELL_GIT=$(grep -oP '^%global commit\s+\K[a-f0-9]+' quickshell/quickshell-git.spec | head -c 7)
          
          echo "COPR quickshell-git: $COPR_QUICKSHELL_GIT"
          echo "Current quickshell-git: $CURRENT_QUICKSHELL_GIT"
          
          if [[ "$COPR_QUICKSHELL_GIT" != "not_found" && "$COPR_QUICKSHELL_GIT" != *"$CURRENT_QUICKSHELL_GIT"* ]]; then
            echo "copr_behind=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ COPR is behind! Current: $CURRENT_QUICKSHELL_GIT, COPR: $COPR_QUICKSHELL_GIT"
          else
            echo "copr_behind=false" >> $GITHUB_OUTPUT
            echo "âœ… COPR is up to date"
          fi

      - name: Commit and push changes
        if: steps.update.outputs.has_changes == 'true'
        run: |
          # Get list of changed spec files for commit message
          CHANGED_SPECS=$(git diff --name-only | grep '\.spec$' | xargs basename -a | tr '\n' ', ' | sed 's/,$//')

          git add -A
          git commit -m "Auto-update packages: $CHANGED_SPECS

          ðŸ¤– Automated update by GitHub Actions

          Updated packages:
          $(git diff HEAD~1 --name-only | grep '\.spec$' | sed 's/^/  - /')

          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          git push

      - name: Create update summary
        if: steps.update.outputs.has_changes == 'true'
        run: |
          echo "## ðŸ“¦ Package Updates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following packages were updated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse update log for changes
          if grep -q "Update available" update-log.txt; then
            grep "Update available" update-log.txt | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
          git diff HEAD~1 --name-only | grep '\.spec$' | sed 's/^/- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View commit](https://github.com/${{ github.repository }}/commit/$(git rev-parse HEAD))" >> $GITHUB_STEP_SUMMARY

      - name: Upload update log
        if: steps.update.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: update-log-${{ github.run_number }}
          path: update-log.txt
          retention-days: 30

  trigger-copr-builds:
    name: Trigger COPR builds
    needs: update-packages
    runs-on: ubuntu-latest
    if: (needs.update-packages.outputs.has_changes == 'true' || needs.update-packages.outputs.copr_behind == 'true') && (github.event.inputs.trigger_builds == 'true' || github.event_name == 'schedule' || github.event_name == 'push')

    steps:
      - name: Debug condition
        run: |
          echo "has_changes: ${{ needs.update-packages.outputs.has_changes }}"
          echo "copr_behind: ${{ needs.update-packages.outputs.copr_behind }}"
          echo "trigger_builds: ${{ github.event.inputs.trigger_builds }}"
          echo "event_name: ${{ github.event_name }}"
          echo "Condition result: ${{ (needs.update-packages.outputs.has_changes == 'true' || needs.update-packages.outputs.copr_behind == 'true') && (github.event.inputs.trigger_builds == 'true' || github.event_name == 'schedule' || github.event_name == 'push') }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Install COPR CLI
        run: |
          sudo dnf install -y copr-cli || sudo apt-get install -y copr-cli || {
            echo "âš ï¸ Could not install copr-cli via package manager"
            echo "Installing via pip..."
            pip install copr-cli
          }

      - name: Configure COPR
        env:
          COPR_CONFIG: ${{ secrets.COPR_CONFIG }}
        run: |
          if [[ -z "$COPR_CONFIG" ]]; then
            echo "âŒ COPR_CONFIG secret not set"
            echo "Please add your COPR configuration as a repository secret named COPR_CONFIG"
            exit 1
          fi

          mkdir -p ~/.config
          echo "$COPR_CONFIG" > ~/.config/copr
          chmod 600 ~/.config/copr

      - name: Trigger builds
        run: |
          chmod +x scripts/trigger-copr.sh
          ./scripts/trigger-copr.sh

      - name: Build summary
        run: |
          echo "## ðŸš€ COPR Builds Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Builds have been triggered for updated packages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View builds](https://copr.fedorainfracloud.org/coprs/avengemedia/danklinux/builds/)" >> $GITHUB_STEP_SUMMARY

    outputs:
      has_changes: ${{ needs.update-packages.outputs.has_changes }}
